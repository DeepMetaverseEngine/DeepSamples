---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xujing.xu.
--- DateTime: 2018/12/14 10:26
---成就 AchievementModel
--- Achievement   AchievementList

local _M = {}
_M.__index = _M


_M.AchievementType=
{
    NoVaild = 0,
    NotCompleted = 1,
    WaitForGetReward = 2,
    Finished = 3,
}

_M.Hexagram={
    Low = '#dynamic/TL_achievement/output/TL_achievement.xml|TL_achievement|28',
    Mid ='#dynamic/TL_achievement/output/TL_achievement.xml|TL_achievement|29',
    High = '#dynamic/TL_achievement/output/TL_achievement.xml|TL_achievement|30',
}


function _M.GetAchDataByAchId(achid)
    local data = unpack(GlobalHooks.DB.Find('Achievement', { id = achid }))
    return data
end

--获取所有可见的成就大类
function _M.GetAllAchDataType()
    local allach=GlobalHooks.DB.Find('AchievementList',function (ach)
        return ach.is_valid == 1
    end)
    table.sort(allach,function (a,b)
        return a.rank > b.rank
    end)
    return allach
end


function _M.GetOneAchDataType(type)
    local data = unpack(GlobalHooks.DB.Find('AchievementList', { type = type }))
    return data
end


function _M.InsertAndSort(tab,sou)
    for i, v in ipairs(sou) do
        local data=_M.GetOneAchDataType(v.type)
        if data then
            table.insert(tab,data)
        end
        table.sort(tab,function (a,b)
            return a.type < b.type
        end)
    end
end

-----------------------Net-----------------------


--获取奖励列表
function _M.RequestGetAchievementList(type,cb)
    local request = {c2s_type = type}
    Protocol.RequestHandler.TLClientAchievementListRequest(request, function(rsp)
        if cb then
            cb(rsp)
        end
    end)
end


--领取成就奖励
function _M.RequestGetAchievementReward(achid,cb)
    local request = {c2s_id = achid}
    Protocol.RequestHandler.TLClientGetAchievementRewardRequest(request, function(rsp)
        if cb then
            cb(rsp)
        end
    end)
end


_M.WaitShowAchievement={}
_M.RedPointList={}
--完成成就，存入表内，按顺序弹框
local function OnAchievementCompletedNotify(notify)
    if notify.ShowTips then
        EventManager.Fire("Event.Achievement.AchievementComplete",notify)
        --如果完成有奖励的成就，显示红点
        if notify.s2c_data[1].state ==_M.AchievementType.WaitForGetReward then
            table.insert(_M.RedPointList,notify.s2c_data[1])
            GlobalHooks.UI.SetRedTips('achievement',1)
        end
        table.insert(_M.WaitShowAchievement,notify.s2c_data[1])
        if not GlobalHooks.UI.FindUI('AchievementTip') then
            GlobalHooks.UI.OpenMsgBox('AchievementTip',0,_M.WaitShowAchievement[1])
        end
    else
        _M.RedPointList = notify.s2c_data
        for i, v in ipairs(notify.s2c_data) do
            if v.state == _M.AchievementType.WaitForGetReward then
                GlobalHooks.UI.SetRedTips('achievement',1)
                break
            end
        end
    end
end


function _M.InitNetWork(initNotify)
    if initNotify then
        Protocol.PushHandler.TLClientAchievementCompletedNotify(OnAchievementCompletedNotify)--监听成就完成消息
    end
end


return _M

