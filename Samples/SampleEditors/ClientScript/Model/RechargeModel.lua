---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xujing.xu.
--- DateTime: 2018/9/11 9:56
---

local _M = {}
_M.__index = _M

local UIUtil = require 'UI/UIUtil'
local Util = require 'Logic/Util'
local BusinessModel = require 'Model/BusinessModel'
_M.BuyInfo={}
_M.GoToYuanBao=false
--mycard渠道id
_M.MyCardPlatformID = 2002

_M.OS={
    OTHER=0,
    IOS=5,
    ANDROID=6,
    WP=7,
}

--是否显示mycard按钮
_M.ShowRechargeBtn = false

--mycard是否代替苹果内购
--(UITAG获取充值信息,包含RechargePay,RechargeGift,FirstRecharge,白凤九礼包)
--成长基金，周卡特权
_M.MyCardInsteadofIos = false
function _M.GetRechargePlatformID(ismycard)
    if PublicConst.OSType == _M.OS.IOS and _M.MyCardInsteadofIos then
        return _M.MyCardPlatformID
    else
        if ismycard then
            return _M.MyCardPlatformID
        else
            return OneGameSDK.Instance.PlatformID
        end
    end
end

--通过id获取指定充值信息
local function GetCommonRechargeByRechargeId(rechargeid)
    local rechargeData=unpack(GlobalHooks.DB.Find('RechargeCommon',{id=rechargeid}))
    return rechargeData
end
--获取上架中的充值数据
local function  GetAllShowCommonRecharge()
    local allrechargeData=GlobalHooks.DB.Find('RechargeCommon',function (add)
        return add.is_selling==1
    end)
    table.sort(allrechargeData,function(a,b) return a.order <b.order end)
    return allrechargeData
end


--通过id获取指定礼包信息
local function GetShowGiftRechargeById(rechargeid)
    local rechargeData=unpack(GlobalHooks.DB.Find('RechargeGift',{id=rechargeid}))
    return rechargeData
end
--获取上架中的礼包数据
local function  GetAllShowGiftRecharge()
    local allgiftData=GlobalHooks.DB.Find('RechargeGift',function (add)
        return add.exp_vip >=0
    end)
    table.sort(allgiftData,function(a,b) return a.id <b.id end)
    return allgiftData
end


--获取成长基金产品id
function _M.GetFundProductById(fundid)
    local rechargeData=unpack(GlobalHooks.DB.Find('RechargeFundProduct',{id = fundid}))
    return rechargeData
end


--获取所有的周卡信息
local function GetAllCardInfo()
    local allrechargeData=GlobalHooks.DB.Find('RechargeTime',function (add)
        return add.is_selling==1
    end)
    table.sort(allrechargeData,function(a,b) return a.order <b.order end)
    return allrechargeData
end
--获取上架中的周卡信息
local function GetShowCardById(cardid)
    local rechargeData=unpack(GlobalHooks.DB.Find('RechargeTime',{id=cardid}))
    return rechargeData
end


--获取所有每日充值信息
local function GetAllDailyRechargeInfo()
    local allrechargeData=GlobalHooks.DB.Find('RechargeDaily',function (add)
        return add.is_selling==1
    end)
    table.sort(allrechargeData,function(a,b) return a.order <b.order end)
    return allrechargeData
end
--获取上架中的每日充值信息
local function GetShowDailyRechargeInfo(dailyid)
    local rechargeData=unpack(GlobalHooks.DB.Find('RechargeDaily',{id=dailyid}))
    return rechargeData
end


--通过物品id获取
local function GetStoreDataByItemId(id,storetype)
    local storeData=unpack(GlobalHooks.DB.Find('Store',{item_id =id,store_type = storetype}))
    return storeData
end


--获取所有vip信息
local function GetAllVipInfo()
    local all=GlobalHooks.DB.GetFullTable('vip_show')
    table.sort(all,function (a,b) 
        return a.id <b.id 
    end)
    return all
end


--获取指定vip等级信息
local function GetVipLevelInfo(viplevel)
    local vipinfo=unpack(GlobalHooks.DB.Find('vip_show',function (add)
        return add.vip_level ==viplevel
    end))
    return vipinfo
end


--获取指定vip礼包信息
local function GetVipLevelSet(viplevel)
    local vipinfo=unpack(GlobalHooks.DB.Find('vip_set',function (add)
        return add.vip_level ==viplevel
    end))
    return vipinfo
end


--获取首充信息
local function GetFirstRechargeInfo(recharge_rank)
    local allinfo = GlobalHooks.DB.GetFullTable('RechargeFirst')
    local firstrechargeData={}
    for i, v in ipairs(allinfo) do
        if v.job == DataMgr.Instance.UserData.Pro and v.rank == recharge_rank then
            table.insert(firstrechargeData,allinfo[i])
        end
    end
    table.sort(firstrechargeData,function (a,b)
        return a.day < b.day
    end)
    return firstrechargeData
end


--获取所有成长基金数据
function _M.GetAllFundData()
    local all=GlobalHooks.DB.GetFullTable('fund_recharge')
    table.sort(all,function (a,b)
        return a.order <b.order
    end)
    return all
end


--获取所有全民福利的数据
function _M.GetAllFundPlayerData()
    local all=GlobalHooks.DB.GetFullTable('fund_allplayer')
    table.sort(all,function (a,b)
        return a.order <b.order
    end)
    return all
end

--获取累充信息
function _M.GetAllAccumulateRechargeInfo()
    local all=GlobalHooks.DB.GetFullTable('accumulate_recharge')
    table.sort(all,function (a,b)
        return a.order <b.order
    end)
    return all
end
function _M.GetOneAccumulateRechargeInfo(accid)
    local rechargeData=unpack(GlobalHooks.DB.Find('accumulate_recharge',{id=accid}))
    return rechargeData
end


--通过key查找vip相关信息
local function GetVipInfoValueByKey(key,vip)
    local viplv=vip or DataMgr.Instance.UserData.VipLv or 0
    local info = unpack(GlobalHooks.DB.Find('vip_info',{vip_level = viplv}))
    for k, v in pairs(info) do
        if k==key then
            return v
        end
    end
    for i = 1, #info.effect.key do
        if info.effect.key[i]==key then
            return info.effect.val[i]
        end
    end
end


--二次弹框提示(购买次数/扫荡等)
function _M.PopUpWindows(event_key)
    --消耗
    local cost=unpack(GlobalHooks.DB.Find('vip_cost',{event_key = event_key}))
    --是否允许购买额外次数
    local allow=GetVipInfoValueByKey(event_key)
    
    --vip等级不足多语言
    local notenoughlv=Util.GetText('vip_not_enough_level')
    --元宝不足多语言
    local notenoughgold=Util.GetText('vip_not_enough_gold')
    --购买额外次数多语言
    local buyextracount =Util.GetText('vip_buy_extra_count',cost.cost.num[1])
    
    --vip等级不足，引导充值界面
    if allow <1 then
        GameAlertManager.Instance:ShowAlertDialog(AlertDialog.PRIORITY_NORMAL, notenoughlv,'','',nil,
                function ()
                    GlobalHooks.UI.OpenUI('Recharge',0, 'RechargePay')
                end
        ,nil)
        return
    end
    --元宝不足，引导充值界面
    if DataMgr.Instance.UserData:GetAttribute(UserData.NotiFyStatus.DIAMOND) < cost.cost.num[1] then
        GameAlertManager.Instance:ShowAlertDialog(AlertDialog.PRIORITY_NORMAL, notenoughgold,'','',nil,
                function ()
                    GlobalHooks.UI.OpenUI('Recharge',0, 'RechargePay')
                end
        ,nil)
        return
    end
    
    return buyextracount
end


----------------------------Net----------------------------


--请求充值信息
--(UITAG,RechargePay,RechargeGift,FirstRecharge,ActivityType_12)
local function RequestRechargeInfo(platformid,cb)
    local request= {c2s_platform_id=platformid}
    Protocol.RequestHandler.ClientGetRechargeInfoRequest(request, function(rsp)
        if cb then
            cb(rsp)
        end
    end)
end


--请求周卡信息
local function RequestTimeRechargeInfo(platformid,cb)
    local request= {c2s_platformID=platformid}
    Protocol.RequestHandler.ClientGetTimeRechargeInfoRequest(request, function(rsp)
        if cb then
            cb(rsp)
        end
    end)
end


--请求每日礼包信息
local function RequestDailyRechargeInfo(platformid,cb)
    local request= {c2s_platformID=platformid}
    Protocol.RequestHandler.ClientGetDailyRechargeGiftInfoRequest(request, function(rsp)
        if cb then
            cb(rsp)
        end
    end)
end


--购买商品
local function RequestRechargeBySellId(productid,platformid,signature,queryOrder,cb)
    local request={c2s_product_id=productid,c2s_platform_id=platformid,c2s_ext_data={needSignature=signature,queryOrder=queryOrder}}
    Protocol.RequestHandler.ClientGetRechargeOrderRequest(request, function(rsp)
        if cb then
            cb(rsp)
        end
    end)
end


--请求支付结果
local function RequestRechargeResult(orders,ischeck,cb)
    local request= {c2s_list=orders,c2s_check_order=ischeck}
    Protocol.RequestHandler.ClientRechargePayResultRequest(request, function(rsp)
        if cb then
            cb(rsp)
        end
    end)
end


--请求vip相关信息
local function RequestVipInfo(cb)
    local request= {}
    Protocol.RequestHandler.ClientVIPInfoRequest(request, function(rsp)
        if cb then
            cb(rsp)
        end
    end)
end


--请求领取vip礼包
local function RequestGetVipReward(viplv,cb)
    local request= {c2s_viplv=viplv}
    Protocol.RequestHandler.ClientGetVIPRewardRequest(request, function(rsp)
        if cb then
            cb(rsp)
        end
    end)
end


--请求领取周卡礼包
local function RequestGetTimeRechargeReward(productid,cb)
    local request= {c2s_productID=productid}
    Protocol.RequestHandler.ClientGetTimeRechargeRewardRequest(request, function(rsp)
        if cb then
            cb(rsp)
        end
    end)
end


--请求成长基金礼包信息
function  _M.RequestFundInfo(platformid,cb)
    local request= {c2s_platformID=platformid}
    Protocol.RequestHandler.ClientGetFundInfoRequest(request, function(rsp)
        if cb then
            cb(rsp)
        end
    end)
end


--设置title里面相关vip信息(进度条，图标，文字)
local function SetVipLvAndPro(vipgg,viplb,vipib,vippoint)
    
    local viplevel=DataMgr.Instance.UserData.VipLv or 0
    local vipinfo=GetVipLevelInfo(viplevel)
    local vipgift=GetVipLevelSet(viplevel)
    
    vipgg.Text=vippoint..'/'..vipgift.vip_exp
    if vipgift.vip_exp ==0 then
        vipgg.Value=0
    else
        vipgg.Value=((vippoint/vipgift.vip_exp)*100 <100 and {(vippoint/vipgift.vip_exp)*100} or {100})[1]
    end
        viplb.Text=Util.GetText(vipinfo.vip_name)
        UIUtil.SetImage(vipib,vipinfo.vip_pic)
end


--刷新界面
local function OnRechargeInfoChangeNotify(notify)
    local params={
        buycount=notify.s2c_data
    }
    --通知ui刷新界面
    EventManager.Fire('Event.Recharge.RechargeUIUpdate',params)
end


--货币不足
local function OnShowShoppingTipsNotify(notify)
   FunctionUtil.Goto(notify.c2s_functionid,notify.c2s_message)
end


--刷新周卡
local function OnTimeRechargeInfoChangeNotify(notify)
    local params={
        buyinfo=notify.s2c_list
    }
    EventManager.Fire('Event.Recharge.TimeRechargeUIUpdate',params)
end

local function OnPlantingBuyNotify(notify)
    EventManager.Fire('Event.Recharge.PlantingBuy',notify)
end


--刷新每日礼包
local  function OnDailyRechargeInfoChangeNotify(notify)
    local params={
        buyinfo=notify.s2c_list
    }
    EventManager.Fire('Event.Recharge.DailyRechargeUIUpdate',params)
end


--刷新成长基金礼包
local function OnFundInfoChangeNotify(notify)
    local params={
        info=notify.s2c_map
    }
    EventManager.Fire('Event.Recharge.FundInfoUIUpdate',params)
end


--删除订单
local function OnClientRechargeNotify(notify)
    local params={
        orderid=notify.c2s_order_id,
        resultstatus=notify.s2c_result,
    }
    OneGameSDK.Instance:RemoveOrder(DataMgr.Instance.UserData.RoleID,params.orderid)
end


--sdk相关支付流程      订单详情/是否支持订单查询
local function SDKPayment(ord,queryOrder,platformid)
    OneGameSDK.Instance:SaveOrder(DataMgr.Instance.UserData.RoleID,ord.cpOrderId)--保存订单
        OneGameSDK.Instance:Pay({
            [SDKAttName.PLATFORM_ID]=platformid,
            [SDKAttName.PAY_AMOUNT]=tostring(ord.amount),
            [SDKAttName.PAY_ORDERID]=ord.cpOrderId,
            [SDKAttName.PAY_SIGNATURE]=ord.signature,
            [SDKAttName.PAY_ACCOUNTID]=ord.accountId,
            [SDKAttName.PAY_SELLID]=ord.sellID,
            [SDKAttName.PAY_PRODUCTNAME]=ord.productName,
            [SDKAttName.ROLE_BALANCE]=DataMgr.Instance.UserData:GetAttribute(UserData.NotiFyStatus.DIAMOND),
            [SDKAttName.VIP_LEVEL]=DataMgr.Instance.UserData.VipLv,
            [SDKAttName.ROLE_LEVEL]=DataMgr.Instance.UserData.Level,
            [SDKAttName.PARTY_NAME]=DataMgr.Instance.UserData.GuildName,
            [SDKAttName.ROLE_NAME]=DataMgr.Instance.UserData.Name,
            [SDKAttName.ROLE_ID]=DataMgr.Instance.UserData.RoleID,
            [SDKAttName.SERVER_NAME]=DataMgr.Instance.UserData.ServerName,
            [SDKAttName.SERVER_ID]=DataMgr.Instance.UserData.ServerID,
            [SDKAttName.PAY_PRODUCTDESC]=ord.productName,
            [SDKAttName.ROLE_CREATE_TIME]=DataMgr.Instance.UserData.RoleCreateTime},
                function (result) -- -1 取消支付 0 支付失败 1 支付成功 2 支付进行中
                    if tonumber(result)==-1 then --取消支付，删除订单
                        OneGameSDK.Instance:RemoveOrder(DataMgr.Instance.UserData.RoleID,ord.cpOrderId)
                    end
                    if tonumber(result)==1 then --支付成功，查询订单状态
                        local tab ={}
                        local o={}
                        o.c2s_order_id=ord.cpOrderId
                        o.c2s_ext_map= {queryOrder= tostring(queryOrder)}
                        table.insert(tab,o)
                        RequestRechargeResult(tab,false,function (rsp)
                            BusinessModel.Notify("PaySuccess")
                            EventManager.Fire('Event.VIP.VipProductPaySuccess',{})--购买vip产品成功后发送事件通知
                        end)
                    end
                end)
end


--检查无用的订单
 function CheckUselessOrder(sp)
        --获取所有的订单id
        local orders=OneGameSDK.Instance:GetOrderList(DataMgr.Instance.UserData.RoleID)
        local querorder = OneGameSDK.Instance:GetPlatformData():GetInt(SDKAttName.QUERY_ORDER)
        if orders.Count <=0 then
            return
        end
    
        local tab={}
        for ord in Slua.iter(orders) do
            local o = {}
            o.c2s_order_id=ord
            o.c2s_ext_map= {queryOrder= tostring(querorder)}
            table.insert(tab,o)
        end
    
        RequestRechargeResult(tab,true,function (rsp)
            sp:RefreshShowCell()
        end)
end


--添加首充小红点
local function OnRechargeSuccess(eventname,params)
    local any=HudManager.Instance:GetHudUI("MainHud"):FindChildByEditName("cvs_firstrecharge", true)
    if any.Visible then
        local tip=any:FindChildByEditName('lb_tip',true)
        GlobalHooks.UI.ShowRedPoint(tip,1,'FirstRechargeEnable')
    end
end


_M.oldvip=0
_M.newvip=0
function _M.Notify(status, userdata)
    --当vip等级提升时
    if _M.oldvip < 0 then
        _M.oldvip=DataMgr.Instance.UserData.VipLv
    end
    if userdata:ContainsKey(status, UserData.NotiFyStatus.VIP)then
        _M.newvip=DataMgr.Instance.UserData.VipLv
        if _M.newvip > _M.oldvip then
            GlobalHooks.UI.SetRedTips('vipgift_reward',1)
        end
            _M.oldvip=_M.newvip
    end
end

function _M.initial()
    EventManager.Subscribe("Event.VIP.VipProductPaySuccess", OnRechargeSuccess)
    DataMgr.Instance.UserData:AttachLuaObserver('RechargeModel',_M)
end

function _M.fin()
    EventManager.Unsubscribe("Event.VIP.VipProductPaySuccess", OnRechargeSuccess)
    DataMgr.Instance.UserData:DetachLuaObserver('RechargeModel')
end

--初始化网络，监听订单状态事件
function _M.InitNetWork(initNotify)
    if initNotify then
        Protocol.PushHandler.ClientRechargeOrderStatusChange(OnClientRechargeNotify)
        Protocol.PushHandler.ClientRechargeInfoChangeNotify (OnRechargeInfoChangeNotify)
        Protocol.PushHandler.ClientTimeRechargeInfoInfoNotify (OnTimeRechargeInfoChangeNotify)
        Protocol.PushHandler.ClientGetDailyRechargeGiftInfoNotify (OnDailyRechargeInfoChangeNotify)
        Protocol.PushHandler.ClientFundInfoNotify (OnFundInfoChangeNotify)
        Protocol.PushHandler.ClientCostNotEnoughNotify(OnShowShoppingTipsNotify)
        Protocol.PushHandler.ClientPlantingInfoNotify(OnPlantingBuyNotify)
    end
    --上线判断是否显示红点
    if not initNotify then  
        RequestVipInfo(function (rsp)
            for i = 0, #rsp.s2c_vip_reward_record do
                if rsp.s2c_vip_reward_record[i] == true then
                    GlobalHooks.UI.SetRedTips('vipgift_reward',1)
                    break
                end
                GlobalHooks.UI.SetRedTips('vipgift_reward',0)
            end
        end)
    end
end


_M.RequestDailyRechargeInfo=RequestDailyRechargeInfo
_M.RequestGetTimeRechargeReward=RequestGetTimeRechargeReward
_M.RequestTimeRechargeInfo=RequestTimeRechargeInfo
_M.GetShowDailyRechargeInfo=GetShowDailyRechargeInfo
_M.GetAllDailyRechargeInfo=GetAllDailyRechargeInfo
_M.GetShowCardById=GetShowCardById
_M.GetAllCardInfo=GetAllCardInfo
_M.CheckUselessOrder=CheckUselessOrder
_M.GetShowGiftRechargeById=GetShowGiftRechargeById
_M.SetVipLvAndPro=SetVipLvAndPro
_M.SDKPayment=SDKPayment
_M.RequestGetVipReward=RequestGetVipReward
_M.RequestVipInfo=RequestVipInfo
_M.GetVipLevelSet=GetVipLevelSet
_M.GetVipLevelInfo=GetVipLevelInfo
_M.GetAllVipInfo=GetAllVipInfo
_M.RequestRechargeResult=RequestRechargeResult
_M.RequestRechargeBySellId=RequestRechargeBySellId
_M.RequestRechargeInfo=RequestRechargeInfo
_M.GetAllShowGiftRecharge=GetAllShowGiftRecharge
_M.GetCommonRechargeByRechargeId=GetCommonRechargeByRechargeId
_M.GetAllShowCommonRecharge=GetAllShowCommonRecharge
_M.GetVipInfoValueByKey=GetVipInfoValueByKey
_M.GetFirstRechargeInfo=GetFirstRechargeInfo
_M.GetStoreDataByItemId=GetStoreDataByItemId

return _M