---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xujing.xu.
--- DateTime: 2018/9/12 10:31
---
local _M = {}
_M.__index = _M


local DungeonDescType={
    Normal=1, --普通无参
    KillMonster=2,--击杀怪物(param--kill)
    KillAndRoundAndItem=3, --核心本(param--kill,round,exp/item...)
    MyBeastsBoss=4, --神兽陪练boss
    MyBeastsMonster=5,--神兽陪练小怪
    LayerAndRound=6,--镇妖塔层数&波数
    Layer=7,--双飞塔层数
}

local Util = require( 'Logic/Util')
local PagodaModel = require('Model/PagodaModel')

local self = {}
local lb_name
local lb_tip 
local lb_desc 
local desc --读表获取对应描述/提示
local kill =0
local round=0
local item=0
local monsternum=0
local bosshp=0 --神兽陪练boss血量
local bouns=0 --神兽陪练boss奖励档
local mapdata=nil
local PagodaLayer=0 --镇妖塔层数
local PagodaRound=0 --镇妖塔波数
local isshow=false
local IsDoubleTower


function _M.init(cvs)
    self.cvs = cvs
    lb_name= self.root:FindChildByEditName('lb_name',true)
    lb_tip= self.root:FindChildByEditName('lb_tishi',true)
    lb_desc= self.root:FindChildByEditName('lb_neirong',true)

    --设置锚点(左上)
    lb_tip.EditTextAnchor = CommonUI.TextAnchor.L_T
    lb_desc.EditTextAnchor = CommonUI.TextAnchor.L_T
    lb_desc.FontSize=16 --策划要求描述文本小一号

    --自动换行
    lb_tip.TextGraphics.horizontalOverflow = UnityEngine.HorizontalWrapMode.Wrap
    lb_desc.TextGraphics.horizontalOverflow = UnityEngine.HorizontalWrapMode.Wrap
end


local function OnShowUI(eventname,params)
    local root = HudManager.Instance:GetHudUI("TeamQuest")
    self.root = root:FindChildByEditName("cvs_fuben",true)
    _M.init(self.root)
end


--将副本需要显示的内容连接起来
local function ConcatString(dungeontable)
    local str = {}
    for i = 1, desc.tips_number do
        table.insert( str,Util.GetText(dungeontable[i])..'\n')
    end
    return table.concat(str)
end

--根据掉血百分比计算奖励
local function CalcBounsByBossHp(bosshp)
    local boss =unpack(GlobalHooks.DB.Find('BeastsModeBoss',function (add)
        return  add.hp_min <= bosshp and bosshp <= add.hp_max
    end))
    return boss.reward_lv
end

local function MathClamp(v, minValue, maxValue)
    if v < minValue then
        return minValue
    end
    if( v > maxValue) then
        return maxValue
    end
    return v
end


local function GetNextBouns(bouns)
    bouns=bouns+1
    bouns=MathClamp(bouns,1,13)
    local boss =unpack(GlobalHooks.DB.Find('BeastsModeBoss',{reward_lv=bouns}))
    return boss.hp_min
end

--根据类型显示不同描述
local function ShowDesc(dungeontable,desctype,...)
    local params={...}
    if desctype ==DungeonDescType.Normal then --无参
        local str = {}
        for i = 1, desc.condition_number do
            table.insert( str,Util.GetText(dungeontable[i])..'\n')
        end
        return table.concat(str)
    elseif desctype ==DungeonDescType.KillMonster then --需要一个参数(击杀数)
        local str = {}
        for i = 1, desc.condition_number do
            table.insert( str,Util.GetText(dungeontable[i],params[1].kill)..'\n')
        end
        return table.concat(str)
    elseif desctype ==DungeonDescType.KillAndRoundAndItem then--需要三个参数(击杀数，波数，奖励物品)
        if params[1].round ==0  then
            params[1].round=1
        end
        local str={}
        table.insert( str,Util.GetText(dungeontable[1],params[1].round)..'\n')
        table.insert( str,Util.GetText(dungeontable[2],params[1].kill)..'\n')
        table.insert( str,Util.GetText(dungeontable[3],params[1].item)..'\n')
        return table.concat(str)
    elseif desctype ==DungeonDescType.MyBeastsBoss then--需要两个参数(血量，奖励档位)
        if params[1].bouns ==0 or params[1].bouns==nil then
            params[1].bouns=1
        end
        local str={}
        params[1].bouns=MathClamp(params[1].bouns,1,13)
        table.insert( str,Util.GetText(dungeontable[1])..'\n')
        table.insert( str,Util.GetText(dungeontable[2],params[1].bouns)..'\n')
        table.insert( str,Util.GetText(dungeontable[3],params[1].bosshp)..'\n')
        local temp =GetNextBouns(params[1].bouns)
        table.insert( str,Util.GetText(dungeontable[4],temp,(params[1].bouns+1))..'\n')
        return table.concat(str)
    elseif desctype ==DungeonDescType.MyBeastsMonster then--需要三个参数(怪物总数，波数，击杀数)
        if params[1].round ==0  then
            params[1].round=1
        end
        local str={}
        table.insert( str,Util.GetText(dungeontable[1])..'\n')
        table.insert( str,Util.GetText(dungeontable[2],params[1].monsternum)..'\n')
        table.insert( str,Util.GetText(dungeontable[3],params[1].round)..'\n')
        table.insert( str,Util.GetText(dungeontable[4],params[1].kill)..'\n')
        return table.concat(str)
    elseif desctype == DungeonDescType.LayerAndRound then--需要两个参数(层数，波数)
        local str={}
        local lv,lay = PagodaModel.GetNameByFloor(params[1].pagodalay)
        if not string.IsNullOrEmpty(lv) then
            table.insert( str,Util.GetText(dungeontable[1],Util.GetText(lv),lay)..'\n')
        end
        table.insert( str,Util.GetText(dungeontable[2],params[1].pagodaround)..'\n')
        return table.concat(str)
    elseif desctype == DungeonDescType.Layer then--双飞塔
        if IsDoubleTower then
            local str={}
            for i = 1, desc.condition_number do
                table.insert( str,Util.GetText(dungeontable[i],PagodaModel.GetDoubleFlyTowerLayer(params[1].pagodalay))..'\n')
            end
            return table.concat(str)
        else
            local str={}
            for i = 1, desc.condition_number do
                table.insert( str,Util.GetText(dungeontable[i],params[1].pagodalay)..'\n')
            end
            return table.concat(str)
        end
    end
end


--判断是否需要显示副本提示
local function IsShowTips()
    --单机模式增加保护
    if not GameGlobal.Instance.netMode then
        return false
    end
    mapdata=unpack(GlobalHooks.DB.Find('MapData',{id=DataMgr.Instance.UserData.MapTemplateId}))
    isshow = mapdata.dungeondesc ~=0
    return mapdata.dungeondesc ~=0
end

--进入场景时调用
local function OnEnterScene()
    IsDoubleTower = DataMgr.Instance.UserData.MapTemplateId == 500041 or DataMgr.Instance.UserData.MapTemplateId ==500042
    
    if  not IsShowTips() then
        return
    end
    kill =0
    round=0
    item=0
    monsternum=0
    bosshp=0
    bouns=0
    PagodaLayer=0
    PagodaRound=0
    lb_desc.Text = ''
    
    --通过副本描述id查找对应的显示内容
    desc=unpack(GlobalHooks.DB.Find('DungeonDesc',{id=mapdata.dungeondesc}))
    if desc~=nil then
        lb_name.Text=Util.GetText(unpack(GlobalHooks.DB.Find('MapData',{id=DataMgr.Instance.UserData.MapTemplateId})).name)--无法及时取到地图名字，先用这个办法代替
        lb_tip.Text=ConcatString(desc.tips)
        lb_desc.Text=ShowDesc(desc.condition,desc.type[1],
                {kill=kill,round=round,item=item,
                 monsternum=monsternum,bosshp=bosshp,
                 bouns=bouns,pagodalay=PagodaLayer,
                 pagodaround=PagodaRound})
    end
end


--监听神兽陪练血量
local function OnBossHPChange(eventname,params)
    bosshp=params.BossHP
    bouns=CalcBounsByBossHp(bosshp)
end

--监听奖励变化
local function ChangeBouns(eventname,params)
    item=params.bouns
end


--监听波数，击杀数等数值变化
local function  OnChangeTime(eventname,params)
    if not isshow then
        return
    end
    
    --防报空保护
    if desc == nil then
        mapdata=unpack(GlobalHooks.DB.Find('MapData',{id=DataMgr.Instance.UserData.MapTemplateId}))
        desc=unpack(GlobalHooks.DB.Find('DungeonDesc',{id=mapdata.dungeondesc}))
    end

    --如果是镇妖塔的环境变量
    if eventname == 'Event.SceneStageEvent' then
        PagodaLayer = params.CurLayer
        PagodaRound = params.CurWave
    end
    
    --如果是其他副本的环境变量(不包括镇妖塔)
    --击杀数
    if params.key =='kill' then
        kill=params.value
    end
    --波数
    if params.key == 'round'then
        round=params.value
    end
    --怪物总数
    if params.key=='monster_num' then
        monsternum=params.value
    end
    lb_desc.Text=ShowDesc(desc.condition,desc.type[1],
            {kill=kill,round=round,item=item,
             monsternum=monsternum,bosshp=bosshp,
             bouns=bouns,pagodalay=PagodaLayer,
             pagodaround=PagodaRound})
end


function initial()
    EventManager.Subscribe(Events.UI_HUD_LUAHUDINIT, OnShowUI)
    EventManager.Subscribe("Event.SyncEnvironmentVarEvent", OnChangeTime)
    EventManager.Subscribe("Event.DailyDungeon.Bouns",ChangeBouns)
    EventManager.Subscribe("Event.MyThicalBeasts.BossHP",OnBossHPChange)
    EventManager.Subscribe("Event.SceneStageEvent",OnChangeTime)
end

function fin()
    EventManager.Unsubscribe(Events.UI_HUD_LUAHUDINIT, OnShowUI)
    EventManager.Unsubscribe("Event.SyncEnvironmentVarEvent", OnChangeTime)
    EventManager.Unsubscribe("Event.DailyDungeon.Bouns",ChangeBouns)
    EventManager.Unsubscribe("Event.MyThicalBeasts.BossHP",OnBossHPChange)
    EventManager.Unsubscribe("Event.SceneStageEvent",OnChangeTime)
end

_M.initial=initial
_M.fin=fin
_M.OnEnterScene=OnEnterScene
return _M