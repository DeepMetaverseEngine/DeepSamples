---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xujing.xu.
--- DateTime: 2018/12/21 13:54
---仙侣羁绊   FallenPartnerEntanglement


local _M = {}
_M.__index = _M

local PartnerModel = require'Model/FallenPartnerModel'
local Util   = require 'Logic/Util'
local UIUtil = require 'UI/UIUtil'
local PartnerUtil = require 'UI/Partner/FallenPartnerUtil'
 
_M.AttrType = {
    'attack',
    'maxhp',
    'defend',
    'mdef',
    'thunderdamage',
    'winddamage',
    'icedamage',
    'firedamage',
    'soildamage',
    'thunderresist',
    'windresist',
    'iceresist',
    'fireresist',
    'soilresist',
}

function _M.OnInit(self)

end

--检查该阶是否激活
local function CheckIsActive(self,id)
    if self.actParEnt then
        for i, v in ipairs(self.actParEnt) do
            local a = PartnerModel.GetActInfoById(v)
            local b = PartnerModel.GetActInfoById(id)
            if a.group_id == b.group_id and v >=id then
                return true
            end
        end
        return false
    else
        return false
    end
end

--是否显示彩色(该条羁绊是否激活)
local function ShowEnableOrDisable(tab,data,isshow,lv)
    for i, v in ipairs(tab) do
        v.IsGray = not isshow
        v.Visible = true
    end
    UIUtil.SetImage(tab[1],data.lock_pic,false,UILayoutStyle.IMAGE_STYLE_BACK_4)
    tab[2].Text = Util.GetText(data.god_name)
    tab[3].Text = Util.GetText('strengthen_rank',lv)
end


--属性面板
local function CaluTotalFight(self)
    self.comps.cvs_tips.Visible=true
    self.comps.cvs_tips.TouchClick=function()
        self.comps.cvs_tips.Visible=false
    end
    local node = self.comps.cvs_allattribute
    local lb_fight3 = node:FindChildByEditName('lb_fight3',true)
    lb_fight3.Text = self.fightPower
    for i,v in ipairs(_M.AttrType) do
        local value = self.props[v]
        local attr = node:FindChildByEditName('lb_attribute'..i,true)
        attr.Text = PartnerUtil.AttributeName(v)
        local num = node:FindChildByEditName('lb_val'..i,true)
        num.Text =value
    end
end


local function InitAttr(self,isactive)
    self.comps.lb_classtips.Text= Util.GetText(self.curParEnt.rank_name)
    self.comps.lb_classtips.IsGray = not isactive
    self.comps.lb_able.IsGray = not isactive
    self.comps.lb_able.Text = isactive and Util.GetText('god_book_activation') or Util.GetText('god_book_imactivation')
    local num = 1
    for i,v in ipairs(_M.AttrType) do
        local value = self.curParEnt[v]
        if value > 0 then
            self.attrCollective[num].Text = PartnerUtil.AttributeName(v)
            self.numCollective[num].Text = value
            num = num +1 
        end
    end
    local node  = self.comps.cvs_attr
    for i = 1, 4 do
        local cvs_attr = node:FindChildByEditName('cvs_attr'..i,true)
        cvs_attr.IsGray = not isactive
    end
end


local function GetRank(id,lv)
    local advanceData = PartnerUtil.GetAdvanceData(id,lv)
    if advanceData ~= nil then
        return advanceData.client_rank
    else
        error('error rank with',id,lv)
        return -1
    end
end

local function FindLvInActivePartner(id)
    for i, v in ipairs(PartnerModel.CurHavePartnerList) do
        if v.s2c_god_id == id then
            return  GetRank(v.s2c_god_id,v.s2c_god_lv)
        end
    end
    return -1
end

--检查单个仙侣是否符合羁绊条件
local function CheckOnePartnerActive(id,lv)
    for i, v in ipairs(PartnerModel.CurHavePartnerList) do
        if v.s2c_god_id == id and v.s2c_god_lv >= lv then
            return GetRank(v.s2c_god_id,v.s2c_god_lv),true
        end
    end
    return GetRank(id,lv),false
end

--检查多余的仙侣空位,并重新设置位置
local function CheckUnlessPartner(self,length,partnercond)
    if length < partnercond then
        for i = 1, length do
            self.partnerShow[i][1].Position2D = Vector2(self.partnerShow[i][1].Position2D.x+50*i,self.partnerShow[i][1].Position2D.y)
        end
    end
    if length < partnercond then
        for i = length+1, partnercond do
            for i, v in ipairs(self.partnerShow[i]) do
                v.Visible=false
            end
        end
    end
end

local function InitDetail(self)
    --获取当前类型最大组合数
    local max = PartnerModel.GetMaxCountByGroupId(self.selectType)
    --左右按钮
    self.comps.btn_prev.Visible = self.selectRank > 1
    self.comps.btn_next.Visible = self.selectRank < #max
    self.comps.btn_prev.Text = Util.GetText('strengthen_rank',self.selectRank - 1)
    self.comps.btn_next.Text = Util.GetText('strengthen_rank',self.selectRank + 1)
    self.comps.btn_prev.TouchClick =function ()
        self.selectRank = self.selectRank  <= 1 and 1 or self.selectRank - 1
        InitDetail(self)
    end
    self.comps.btn_next.TouchClick =function ()
        self.selectRank = self.selectRank  >= #max and #max or self.selectRank + 1
        InitDetail(self)
    end
    
    --获取当前选择的仙侣羁绊
    self.curParEnt=PartnerModel.GetPartnerEntanglementByGroupAndRank(self.selectType,self.selectRank)
    self.comps.lb_title.Text = Util.GetText(self.totalType[self.selectType].book_name)
    
    local isActive = CheckIsActive(self,self.curParEnt.id)
    --显示缘分等级加成
    InitAttr(self,isActive)

    --取得图集
    self.parInfo={}
    for i, v in ipairs(self.curParEnt.cond) do
        local p=PartnerModel.GetPartnerInfoById(v.ID)
        table.insert(self.parInfo,p)
    end
    local length = 0
    for i, v in ipairs(self.curParEnt.cond) do
        if v.ID ~= 0 then
            length =length +1
        end
    end
    for i = 1, #self.curParEnt.cond do
        self.partnerShow[i][1].Position2D = self.partnerCvsPos[i]
    end
    --已激活羁绊
    if isActive then
        for i = 1, length do
            ShowEnableOrDisable(self.partnerShow[i],self.parInfo[i],isActive,FindLvInActivePartner(self.curParEnt.cond[i].ID))
        end
            CheckUnlessPartner(self,length,#self.curParEnt.cond)
    else --未激活
        for i = 1, length do
            local lv,isactive=CheckOnePartnerActive(self.curParEnt.cond[i].ID,self.curParEnt.cond[i].Lv)
            ShowEnableOrDisable(self.partnerShow[i],self.parInfo[i],isactive,lv)
        end
            CheckUnlessPartner(self,length,#self.curParEnt.cond)
    end
end


--选择默认激活的羁绊
local function DefaultSelectIndex(self)
    if self.actParEnt then
        for i, v in ipairs(self.actParEnt) do
            local a = PartnerModel.GetActInfoById(v)
            if a.group_id == self.selectType then
                return a.client_rank
            end
        end
        return 1
    else
        return 1
    end
end


local function SetEach(self,node,index)
    node.Text=Util.GetText(self.totalType[index].book_name)
    node.IsChecked = self.selectType == index
    node.TouchClick =function()
        node.IsChecked = true
        if self.selectType == index then
            return
        end
        self.selectType = index
        self.selectRank = DefaultSelectIndex(self) 
        self.comps.sp_list:RefreshShowCell()
        InitDetail(self)
    end
end

local function InitList(self)
    self.comps.btn_attr.TouchClick=function()
        CaluTotalFight(self)
    end
    self.comps.tbt_list.Visible=false
    local function eachupdatecb(node,index)
        SetEach(self,node,index)
    end
    UIUtil.ConfigVScrollPan(self.comps.sp_list,self.comps.tbt_list,#self.totalType,eachupdatecb)
end

local function InitAttrCollective(self)
    self.comps.btn_help.TouchClick = function()
        self.comps.cvs_help.Visible=true
        self.comps.cvs_help.TouchClick= function()
            self.comps.cvs_help.Visible=false
        end
    end
    --属性
    self.attrCollective={}
    self.numCollective={}
    for i = 1, 4 do
        local attr = self.comps.cvs_attr:FindChildByEditName('lb_attr'..i,true)
        local num = self.comps.cvs_attr:FindChildByEditName('lb_num'..i,true)
        table.insert(self.attrCollective,attr)
        table.insert(self.numCollective,num)
    end
    --人物(图片，名字，等级)
    self.partnerShow={}
    self.partnerCvsPos={}
    for i = 1, 3 do
        self.partnerShow[i]={}
        local cvs = self.comps.cvs_show:FindChildByEditName('cvs_partner'..i,true)
        local name = self.comps.cvs_show:FindChildByEditName('lb_use'..i,true)
        local lv = self.comps.cvs_show:FindChildByEditName('lb_class'..i,true)
        table.insert(self.partnerShow[i],cvs)
        table.insert(self.partnerCvsPos,self.partnerShow[i][1].Position2D)
        table.insert(self.partnerShow[i],name)
        table.insert(self.partnerShow[i],lv)
    end
end


local function InitComp(self)
    --获取总共几种分组
    self.totalType=PartnerModel.GetTotalPartnerEntanglementCount()
    --默认第一种分组
    self.selectType = 1
    --默认激活的那一阶(如果没有就第一阶)
    self.selectRank = DefaultSelectIndex(self)
    InitList(self)
    InitAttrCollective(self)
    InitDetail(self)
end


function _M.OnEnter(self)
    PartnerModel.RequestGetGodBookInfo(function (rsp)
        self.fightPower = rsp.s2c_fightpower
        self.props = rsp.s2c_props
        self.actParEnt = rsp.s2c_books
        InitComp(self)
    end)
end


function _M.OnExit(self)
    for i = 1, 3 do
        self.partnerShow[i][1].Position2D = self.partnerCvsPos[i]
    end
end


return _M
